---
title: "Association Rule Mining"
author: "Pedro Ivo Rivas, Robbie Geoghegan, Sebastian Osorio, Rocco Lange"
date: "8/19/2019"
output:
  html_document: default
  md_document: 
    variant: markdown_github
---

```{r, warning=FALSE, message=FALSE, echo = FALSE}
library(tidyverse)
library(arules) 
library(arulesViz)
library(plyr) #splitting, applying and combining data
library(ggplot2)
library(knitr)
library(lubridate)
```


```{r, echo = FALSE}
groceries = as.matrix(read.table("groceries.txt",
                                 header=FALSE,
                                 sep = "\n"))
```

```{r, echo = FALSE} 
#change colname
#colnames(groceries) <- c("items")
#summary(groceries)

```

```{r, echo = FALSE}
#create formate needed for basket analysis
write.csv(groceries, "market_basket_transactions.csv", quote=FALSE, row.names=FALSE)
```

```{r, echo = FALSE}
#load in csv to analyze using read.transactions --> DON"T WORRY ABOUT ERROR MESSAGES
groc_tr <- read.transactions("market_basket_transactions.csv", format = "basket", sep = ",")
```

```{r, echo = FALSE}
#summary(groc_tr)
##This shows 9,836 transactions
#170 items (columns)
#density tells percentage of non-zero cells in the sparse matrix(most elements are zero). It is the total number of items that are purchases divided by the possible number of items in that matrix
#most frequent items are whole milk, other vegetables, buns, rolls and soda
#Numbers belwo show counts of baskets, 3,413 baskets have 1 item, 2,893 basekets have 2 items etc.
```

```{r, echo = FALSE}
#Plot top 20 most purcahsed items
#itemFrequencyPlot(groc_tr, topN=20)
itemFrequencyPlot(groc_tr, topN=20, type="absolute", main = "Counts of 20 most common products")
```

```{r, echo = FALSE}
#set support, confidence and maxlen
association.rules <- apriori(groc_tr, parameter = list(supp=0.005, conf=0.1, maxlen=5))
```
```{r, echo = FALSE}
#look at rules - too many
#inspect(association.rules)
```
```{r, echo = FALSE}
#look at a subset of rules
#inspect(subset(association.rules, subset=lift > 1 & confidence > 0.5))
```
```{r echo = FALSE}
#plot lift and support
plot(association.rules) #confidence and support
plot(association.rules, measure = c("support", "lift"), shading = "confidence") #lift and support
plot(association.rules, method='two-key plot') #confidence and support based on order #
```

```{r echo = FALSE}
sub1 = subset(association.rules, subset=lift > 3.5)
#summary(sub1)
plot(sub1, method='graph', main = "Rules where lift > 3.5")
```

                        INTERACTIVE PLOT WITH TOP 10 RULES BY LIFT

```{r echo = FALSE}
#top 10 rules
sub_rules <- association.rules[quality(association.rules)$confidence>0.4] 
top10_sub_rules <- head(sub_rules, n=10, by = "lift")
plot(top10_sub_rules, method = "graph", engine = "htmlwidget")
```

```{r, echo = FALSE}
#save top 1000 rules to use in Gephi
saveAsGraph(head(sub_rules, n=1000, by = "lift"), file = "groceries_gephi.graphml")
```

The data has a total of 9835 transactions and 170 items. The most frequently purchased items are whole milk, other vegetables, rolls/buns and soda. From the analysis we have found that whole milk and other vegetables have very high betweeness and the top 10 rules in terms of lift are:
1) {citrus fruit, other vegetables, whole milk} => {root vegetables} ; lift = 3.3
2) {herbs} => {root vegatables} ; lift = 4.0
3) {citrus fruit, pip fruit} => {tropical fruit} ; lift = 3.9
4) {other vegetables, tropical fruit, whole milk} => {root vegetables} ; lift = 3.8
5) {other vegetables, pip fruit, whole milk} => {root vegetables} ; lift = 3.7
6) {curd, tropical fruit} => {yogurt} ; lift = 3.7
7) {beef,  other vegetables} => {root vegetables} ; lift = 3.7
8) {fruit/vegetable juice, other vegetables, whole milk} => {yogurt} ; lift = 3.5
9) {root vegetables, tropical fruit, whole milk} => {yogurt} ; lift = 3.4
10) {root vegetables, tropical fruit, whole milk} => {yogurt} ; lift =3.3

This information can be used for strategic placement of products in a grocery store. E.g. given the high lift linking herbs with root vegatables, placing them near each other could increase sales of these products or alternativley, placing them on opposite sides of the store would force people to walk through multiple aisles and increase their chances of purchasing other products.
